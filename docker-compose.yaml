services:
  # Redis для очереди задач
  redis:
    image: redis:7-alpine
    container_name: blog_redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - internal
    profiles: ["dev", "prod"]

  # Push-notificator сервис
  push-notificator:
    image: ghcr.io/ayusavin/push-notification-playground:1.0.0
    container_name: blog_push_notificator
    ports:
      - "8001:8000"
    networks:
      - internal
    profiles: ["prod"]

  # PostgreSQL для backend (articles, comments)
  db-main:
    image: postgres:16
    container_name: blog_db_main
    environment:
      - POSTGRES_DB=blog
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
    ports:
      - "5434:5432"
    volumes:
      - pg_main_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d blog"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - internal
    profiles: ["dev", "prod"]

  # PostgreSQL для users-service
  db-users:
    image: postgres:16
    container_name: blog_db_users
    environment:
      - POSTGRES_DB=users_db
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
    ports:
      - "5435:5432"  # внешний порт +3
    volumes:
      - pg_users_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d users_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - internal
    profiles: ["dev", "prod"]

  # Backend service (articles, comments)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: blog_backend
    env_file:
      - ./backend/.env
    environment:
      - POSTGRES_HOST=db-main
      - POSTGRES_PORT=5432
      - POSTGRES_DB=blog
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
      - REDIS_URL=redis://redis:6379/0
    ports:
      - "8002:8000"
    depends_on:
      db-main:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - internal
    profiles: ["prod"]

  # Users service
  users-api:
    build:
      context: ./users_service
      dockerfile: Dockerfile
    container_name: blog_users_api
    env_file:
      - ./users_service/.env
    environment:
      - POSTGRES_HOST=db-users
      - POSTGRES_PORT=5432
      - POSTGRES_DB=users_db
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
    ports:
      - "8003:8000"  # внешний порт +3
    depends_on:
      db-users:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - internal
    profiles: ["prod"]

  # Worker service (обработка уведомлений)
  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: blog_worker
    env_file:
      - ./worker/.env
    environment:
      - POSTGRES_HOST=db-users
      - POSTGRES_PORT=5432
      - POSTGRES_DB=users_db
      - POSTGRES_USER=app
      - POSTGRES_PASSWORD=app
      - REDIS_URL=redis://redis:6379/0
      - PUSH_URL=http://push-notificator:8000/api/v1/notify
    depends_on:
      db-users:
        condition: service_healthy
      redis:
        condition: service_healthy
      push-notificator:
        condition: service_started
    restart: unless-stopped
    networks:
      - internal
    profiles: ["prod"]

  # API Gateway (Nginx)
  api-gateway:
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    container_name: blog_api_gateway
    ports:
      - "8000:80"
    depends_on:
      - backend
      - users-api
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - internal
    profiles: ["prod"]

networks:
  internal:
    driver: bridge

volumes:
  pg_main_data:
  pg_users_data:
